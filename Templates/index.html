<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Etiket Yazdır</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#007bff">

    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 500px; margin: auto; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        select, input, button { width: 100%; padding: 15px; font-size: 1.1em; box-sizing: border-box; }
        button { background-color: #007bff; color: white; border: none; cursor: pointer; margin-top: 10px; }
        
        /* Sepet Alanı */
        #cart-section { margin-top: 30px; }
        #cart-items li {
            font-size: 1.1em;
            padding: 10px;
            background-color: #f4f4f4;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #cart-items li .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
            width: auto;
        }
        
        #print-all-button { background-color: #28a745; font-weight: bold; }
        #status { font-weight: bold; margin-top: 15px; }

        /* Yönetim Bölümü Stilleri */
        #admin-section {
            margin-top: 40px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }
        #admin-section summary {
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            color: #333;
        }
        .admin-forms {
            padding: 15px;
            background-color: #eee;
            border-radius: 5px;
            margin-top: 10px;
        }
        .admin-forms input { font-size: 1em; padding: 10px; margin-bottom: 10px; }
        .admin-forms button { font-size: 1em; padding: 10px; background-color: #5a6268; }
        #admin-status { font-weight: bold; }

    </style>
</head>
<body>
    <h2>Lider Baharat Etiket Sistemi</h2>
    
    <div class="form-group">
        <label for="spice-select">Baharat Seçin:</label>
        <select id="spice-select">
            {% for baharat in baharat_listesi %}
                <option value="{{ baharat }}">{{ baharat }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="weight-select">Gramaj Seçin:</label>
        <select id="weight-select">
            {% for gramaj in gramaj_listesi %}
                <option value="{{ gramaj }}">{{ gramaj }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="page-count">Sayfa Sayısı:</label>
        <input type="number" id="page-count" value="1" min="1">
    </div>

    <div class="form-group">
        <label for="urt-tarihi">Üretim Tarihi (Tüm Sepet İçin):</label>
        <input type="date" id="urt-tarihi">
    </div>
    
    <button id="add-to-cart-button">SEPETE EKLE</button>
    
    <div id="cart-section">
        <h3>Yazdırma Sepeti</h3>
        <ul id="cart-items">
            </ul>
        <button id="print-all-button" style="display: none;">TÜMÜNÜ YAZDIR</button>
    </div>
    <p id="status"></p>

    <div id="admin-section">
        <details>
            <summary>Listeyi Düzenle (Yeni Öğe Ekle)</summary>
            <div class="admin-forms">
                <div class="form-group">
                    <label for="new-spice">Yeni Baharat Adı:</label>
                    <input type="text" id="new-spice" placeholder="örn: ZERDEÇAL">
                    <button id="add-spice-btn">Yeni Baharat Ekle</button>
                </div>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="new-weight">Yeni Gramaj:</label>
                    <input type="text" id="new-weight" placeholder="örn: 750 GR">
                    <button id="add-weight-btn">Yeni Gramaj Ekle</button>
                </div>
                <p id="admin-status"></p>
            </div>
        </details>
    </div>

    <script>
        // Sepet Elemanları
        const spiceSelect = document.getElementById('spice-select');
        const weightSelect = document.getElementById('weight-select');
        const pageCountInput = document.getElementById('page-count');
        const tarihInput = document.getElementById('urt-tarihi'); // YENİ
        const addToCartBtn = document.getElementById('add-to-cart-button');
        const cartItemsList = document.getElementById('cart-items');
        const printAllBtn = document.getElementById('print-all-button');
        const statusEl = document.getElementById('status');
        
        let cart = []; // Sepet dizisi

        // YÖNETİM Elemanları
        const newSpiceInput = document.getElementById('new-spice');
        const addSpiceBtn = document.getElementById('add-spice-btn');
        const newWeightInput = document.getElementById('new-weight');
        const addWeightBtn = document.getElementById('add-weight-btn');
        const adminStatusEl = document.getElementById('admin-status');

        // YENİ: Sayfa yüklendiğinde tarih alanını bugünün tarihi ile doldur
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            tarihInput.value = `${yyyy}-${mm}-${dd}`;
        });

        // ---- SEPET FONKSİYONLARI ----

        addToCartBtn.addEventListener('click', () => {
            const spice = spiceSelect.value;
            const weight = weightSelect.value;
            const pages = parseInt(pageCountInput.value);

            if (pages < 1) {
                statusEl.textContent = "Hata: Sayfa sayısı en az 1 olmalı.";
                return;
            }
            const labelName = spice + "    " + weight; 
            cart.push({ label: labelName, pages: pages });
            renderCart();
            statusEl.textContent = `Sepete eklendi: ${labelName} (${pages} sayfa)`;
        });

        function renderCart() {
            cartItemsList.innerHTML = '';
            if (cart.length === 0) {
                printAllBtn.style.display = 'none';
                return;
            }
            cart.forEach((item, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${item.label} (${item.pages} sayfa)</span>
                    <button class="delete-btn" data-index="${index}">Sil</button>
                `;
                cartItemsList.appendChild(li);
            });
            printAllBtn.style.display = 'block';
        }

        cartItemsList.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const indexToRemove = parseInt(e.target.dataset.index);
                const removedItem = cart.splice(indexToRemove, 1);
                renderCart();
                statusEl.textContent = `Silindi: ${removedItem[0].label}`;
            }
        });

        // "TÜMÜNÜ YAZDIR" Butonu (GÜNCELLENDİ)
        printAllBtn.addEventListener('click', () => {
            if (cart.length === 0) {
                statusEl.textContent = "Hata: Sepet boş.";
                return;
            }
            
            const date = tarihInput.value; // YENİ: Tarihi al
            if (!date) {
                statusEl.textContent = "Hata: Lütfen geçerli bir üretim tarihi seçin.";
                return;
            }

            statusEl.textContent = 'Tüm sepet yazıcıya gönderiliyor...';
            
            fetch('/print-cart', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                // YENİ: Sepetle birlikte tarihi de gönder
                body: JSON.stringify({ cart: cart, date: date }) 
            })
            .then(response => response.json())
            .then(data => {
                if(data.success) {
                    statusEl.textContent = 'Başarılı: Tüm sepet yazıcıya gönderildi!';
                    cart = [];
                    renderCart();
                } else {
                    statusEl.textContent = `Hata: ${data.message}`;
                }
            })
            .catch(err => {
                statusEl.textContent = 'Hata: Sunucuya bağlanılamadı.';
            });
        });

        // ---- YÖNETİM FONKSİYONLARI (Aynı) ----

        addSpiceBtn.addEventListener('click', () => {
            const spiceName = newSpiceInput.value.trim().toUpperCase();
            if (!spiceName) {
                adminStatusEl.textContent = "Lütfen eklenecek baharat adını girin.";
                return;
            }
            
            adminStatusEl.textContent = "Kaydediliyor...";
            fetch('/add-spice', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ spice_name: spiceName })
            })
            .then(res => res.json())
            .then(data => {
                adminStatusEl.textContent = data.message;
                if (data.success) {
                    setTimeout(() => location.reload(), 1000);
                }
            });
        });

        addWeightBtn.addEventListener('click', () => {
            const weightName = newWeightInput.value.trim().toUpperCase();
            if (!weightName) {
                adminStatusEl.textContent = "Lütfen eklenecek gramajı girin.";
                return;
            }
            
            adminStatusEl.textContent = "Kaydediliyor...";
            fetch('/add-weight', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ weight_name: weightName })
            })
            .then(res => res.json())
            .then(data => {
                adminStatusEl.textContent = data.message;
                if (data.success) {
                    setTimeout(() => location.reload(), 1000);
                }
            });
        });

    </script>
</body>
</html>
